"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NFTTransferOperation = exports.NFTMintOperation = exports.TransferableOperation = exports.Operation = exports.SelectOperationClass = void 0;
/**
 * @packageDocumentation
 * @module AVMAPI-Operations
 */
const buffer_1 = require("buffer/");
const bintools_1 = __importDefault(require("../../utils/bintools"));
const types_1 = require("./types");
const outputs_1 = require("./outputs");
const bintools = bintools_1.default.getInstance();
/**
 * Takes a buffer representing the output and returns the proper [[Operation]] instance.
 *
 * @param opid A number representing the operation ID parsed prior to the bytes passed in
 *
 * @returns An instance of an [[Operation]]-extended class.
 */
exports.SelectOperationClass = (opid, ...args) => {
    if (opid == types_1.AVMConstants.NFTMINTOPID) {
        let nftop = new NFTMintOperation(...args);
        return nftop;
    }
    else if (opid == types_1.AVMConstants.NFTXFEROP) {
        let nftop = new NFTTransferOperation(...args);
        return nftop;
    }
    /* istanbul ignore next */
    throw new Error("Error - SelectOperationClass: unknown opid " + opid);
};
/**
 * A class representing an operation. All operation types must extend on this class.
 */
class Operation {
    constructor() {
        this.sigCount = buffer_1.Buffer.alloc(4);
        this.sigIdxs = []; // idxs of signers from utxo
        /**
           * Returns the array of [[SigIdx]] for this [[Operation]]
           */
        this.getSigIdxs = () => this.sigIdxs;
        this.getCredentialID = () => types_1.AVMConstants.NFTCREDENTIAL;
        /**
           * Creates and adds a [[SigIdx]] to the [[Operation]].
           *
           * @param addressIdx The index of the address to reference in the signatures
           * @param address The address of the source of the signature
           */
        this.addSignatureIdx = (addressIdx, address) => {
            const sigidx = new types_1.SigIdx();
            const b = buffer_1.Buffer.alloc(4);
            b.writeUInt32BE(addressIdx, 0);
            sigidx.fromBuffer(b);
            sigidx.setSource(address);
            this.sigIdxs.push(sigidx);
            this.sigCount.writeUInt32BE(this.sigIdxs.length, 0);
        };
    }
    fromBuffer(bytes, offset = 0) {
        this.sigCount = bintools.copyFrom(bytes, offset, offset + 4);
        offset += 4;
        const sigCount = this.sigCount.readUInt32BE(0);
        this.sigIdxs = [];
        for (let i = 0; i < sigCount; i++) {
            const sigidx = new types_1.SigIdx();
            const sigbuff = bintools.copyFrom(bytes, offset, offset + 4);
            sigidx.fromBuffer(sigbuff);
            offset += 4;
            this.sigIdxs.push(sigidx);
        }
        return offset;
    }
    toBuffer() {
        this.sigCount.writeUInt32BE(this.sigIdxs.length, 0);
        let bsize = this.sigCount.length;
        const barr = [this.sigCount];
        for (let i = 0; i < this.sigIdxs.length; i++) {
            const b = this.sigIdxs[i].toBuffer();
            barr.push(b);
            bsize += b.length;
        }
        return buffer_1.Buffer.concat(barr, bsize);
    }
}
exports.Operation = Operation;
Operation.comparator = () => (a, b) => {
    const aoutid = buffer_1.Buffer.alloc(4);
    aoutid.writeUInt32BE(a.getOperationID(), 0);
    const abuff = a.toBuffer();
    const boutid = buffer_1.Buffer.alloc(4);
    boutid.writeUInt32BE(b.getOperationID(), 0);
    const bbuff = b.toBuffer();
    const asort = buffer_1.Buffer.concat([aoutid, abuff], aoutid.length + abuff.length);
    const bsort = buffer_1.Buffer.concat([boutid, bbuff], boutid.length + bbuff.length);
    return buffer_1.Buffer.compare(asort, bsort);
};
/**
 * A class which contains an [[Operation]] for transfers.
 *
 */
class TransferableOperation {
    constructor(assetid = undefined, utxoids = undefined, operation = undefined) {
        this.assetid = buffer_1.Buffer.alloc(32);
        this.utxoIDs = [];
        /**
           * Returns the assetID as a {@link https://github.com/feross/buffer|Buffer}.
           */
        this.getAssetID = () => this.assetid;
        /**
           * Returns an array of UTXOIDs in this operation.
           */
        this.getUTXOIDs = () => this.utxoIDs;
        /**
           * Returns the operation
           */
        this.getOperation = () => this.operation;
        if (typeof assetid !== 'undefined' && assetid.length === types_1.AVMConstants.ASSETIDLEN
            && operation instanceof Operation && typeof utxoids !== 'undefined'
            && Array.isArray(utxoids)) {
            this.assetid = assetid;
            this.operation = operation;
            for (let i = 0; i < utxoids.length; i++) {
                const utxoid = new types_1.UTXOID();
                if (typeof utxoids[i] === 'string') {
                    utxoid.fromString(utxoids[i]);
                }
                else if (utxoids[i] instanceof buffer_1.Buffer) {
                    utxoid.fromBuffer(utxoids[i]);
                }
                else if (utxoids[i] instanceof types_1.UTXOID) {
                    utxoid.fromString(utxoids[i].toString()); // clone
                }
                this.utxoIDs.push(utxoid);
            }
        }
    }
    fromBuffer(bytes, offset = 0) {
        this.assetid = bintools.copyFrom(bytes, offset, offset + 32);
        offset += 32;
        const numutxoIDs = bintools.copyFrom(bytes, offset, offset + 4).readUInt32BE(0);
        offset += 4;
        this.utxoIDs = [];
        for (let i = 0; i < numutxoIDs; i++) {
            const utxoid = new types_1.UTXOID();
            offset = utxoid.fromBuffer(bytes, offset);
            this.utxoIDs.push(utxoid);
        }
        const opid = bintools.copyFrom(bytes, offset, offset + 4).readUInt32BE(0);
        offset += 4;
        this.operation = exports.SelectOperationClass(opid);
        return this.operation.fromBuffer(bytes, offset);
    }
    toBuffer() {
        const numutxoIDs = buffer_1.Buffer.alloc(4);
        numutxoIDs.writeUInt32BE(this.utxoIDs.length, 0);
        let bsize = this.assetid.length + numutxoIDs.length;
        const barr = [this.assetid, numutxoIDs];
        this.utxoIDs = this.utxoIDs.sort(types_1.UTXOID.comparator());
        for (let i = 0; i < this.utxoIDs.length; i++) {
            const b = this.utxoIDs[i].toBuffer();
            barr.push(b);
            bsize += b.length;
        }
        const opid = buffer_1.Buffer.alloc(4);
        opid.writeUInt32BE(this.operation.getOperationID(), 0);
        barr.push(opid);
        bsize += opid.length;
        const b = this.operation.toBuffer();
        bsize += b.length;
        barr.push(b);
        return buffer_1.Buffer.concat(barr, bsize);
    }
}
exports.TransferableOperation = TransferableOperation;
/**
 * Returns a function used to sort an array of [[TransferableOperation]]s
 */
TransferableOperation.comparator = () => {
    return function (a, b) {
        return buffer_1.Buffer.compare(a.toBuffer(), b.toBuffer());
    };
};
/**
 * A [[Operation]] class which specifies a NFT Mint Op.
 */
class NFTMintOperation extends Operation {
    /**
     * An [[Operation]] class which contains an NFT on an assetID.
     *
     * @param groupID The group to which to issue the NFT Output
     * @param payload A {@link https://github.com/feross/buffer|Buffer} of the NFT payload
     * @param outputOwners An array of outputOwners
     */
    constructor(groupID = undefined, payload = undefined, outputOwners = undefined) {
        super();
        this.groupID = buffer_1.Buffer.alloc(4);
        this.outputOwners = [];
        /**
         * Returns the payload.
         */
        this.getPayload = () => {
            return this.payload;
        };
        /**
         * Returns the outputOwners.
         */
        this.getOutputOwners = () => {
            return this.outputOwners;
        };
        if (typeof groupID !== 'undefined' && typeof payload !== 'undefined' && outputOwners.length) {
            this.groupID.writeUInt32BE((groupID ? groupID : 0), 0);
            this.payload = payload;
            this.outputOwners = outputOwners;
        }
    }
    /**
     * Returns the operation ID.
     */
    getOperationID() {
        return types_1.AVMConstants.NFTMINTOPID;
    }
    /**
     * Popuates the instance from a {@link https://github.com/feross/buffer|Buffer} representing the [[NFTMintOperation]] and returns the size of the output.
     */
    fromBuffer(bytes, offset = 0) {
        offset = super.fromBuffer(bytes, offset);
        this.groupID = bintools.copyFrom(bytes, offset, offset + 4);
        offset += 4;
        let payloadLen = bintools.copyFrom(bytes, offset, offset + 4).readUInt32BE(0);
        offset += 4;
        this.payload = bintools.copyFrom(bytes, offset, offset + payloadLen);
        offset += payloadLen;
        let numoutputs = bintools.copyFrom(bytes, offset, offset + 4).readUInt32BE(0);
        offset += 4;
        this.outputOwners = [];
        for (let i = 0; i < numoutputs; i++) {
            let locktime = bintools.fromBufferToBN(bintools.copyFrom(bytes, offset, offset + 8));
            offset += 8;
            let threshold = bintools.copyFrom(bytes, offset, offset + 4).readUInt32BE(0);
            offset += 4;
            let numaddrs = bintools.copyFrom(bytes, offset, offset + 4).readUInt32BE(0);
            offset += 4;
            let addrs = [];
            for (let j = 0; j < numaddrs; j++) {
                let addr = bintools.copyFrom(bytes, offset, offset + 20);
                addrs.push(addr);
                offset += 20;
            }
            let outputOwner = new outputs_1.OutputOwners(addrs, locktime, threshold);
            this.outputOwners.push(outputOwner);
        }
        return offset;
    }
    /**
     * Returns the buffer representing the [[NFTMintOperation]] instance.
     */
    toBuffer() {
        let superbuff = super.toBuffer();
        let payloadlen = buffer_1.Buffer.alloc(4);
        payloadlen.writeUInt32BE(this.payload.length, 0);
        let outputownerslen = buffer_1.Buffer.alloc(4);
        outputownerslen.writeUInt32BE(this.outputOwners.length, 0);
        let bsize = superbuff.length +
            this.groupID.length +
            payloadlen.length +
            this.payload.length +
            outputownerslen.length;
        let barr = [
            superbuff,
            this.groupID,
            payloadlen,
            this.payload,
            outputownerslen
        ];
        for (let i = 0; i < this.outputOwners.length; i++) {
            let b = this.outputOwners[i].toBuffer();
            barr.push(b);
            bsize += b.length;
        }
        return buffer_1.Buffer.concat(barr, bsize);
    }
    /**
     * Returns a base-58 string representing the [[NFTMintOperation]].
     */
    toString() {
        return bintools.bufferToB58(this.toBuffer());
    }
}
exports.NFTMintOperation = NFTMintOperation;
/**
 * A [[Operation]] class which specifies a NFT Transfer Op.
 */
class NFTTransferOperation extends Operation {
    /**
       * An [[Operation]] class which contains an NFT on an assetID.
       *
       * @param output An [[NFTTransferOutput]]
       */
    constructor(output = undefined) {
        super();
        this.getOutput = () => this.output;
        if (typeof output !== 'undefined') {
            this.output = output;
        }
    }
    /**
       * Returns the operation ID.
       */
    getOperationID() {
        return types_1.AVMConstants.NFTXFEROP;
    }
    /**
       * Popuates the instance from a {@link https://github.com/feross/buffer|Buffer} representing the [[NFTTransferOperation]] and returns the size of the output.
       */
    fromBuffer(bytes, offset = 0) {
        offset = super.fromBuffer(bytes, offset);
        this.output = new outputs_1.NFTTransferOutput();
        return this.output.fromBuffer(bytes, offset);
    }
    /**
       * Returns the buffer representing the [[NFTTransferOperation]] instance.
       */
    toBuffer() {
        const superbuff = super.toBuffer();
        const outbuff = this.output.toBuffer();
        const bsize = superbuff.length + outbuff.length;
        const barr = [superbuff, outbuff];
        return buffer_1.Buffer.concat(barr, bsize);
    }
    /**
       * Returns a base-58 string representing the [[NFTTransferOperation]].
       */
    toString() {
        return bintools.bufferToB58(this.toBuffer());
    }
}
exports.NFTTransferOperation = NFTTransferOperation;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2FwaXMvYXZtL29wcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7O0dBR0c7QUFDSCxvQ0FBaUM7QUFDakMsb0VBQTRDO0FBQzVDLG1DQUF1RDtBQUN2RCx1Q0FBNEQ7QUFHNUQsTUFBTSxRQUFRLEdBQUcsa0JBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQztBQUV4Qzs7Ozs7O0dBTUc7QUFDVSxRQUFBLG9CQUFvQixHQUFHLENBQUMsSUFBVyxFQUFFLEdBQUcsSUFBZSxFQUFZLEVBQUU7SUFDOUUsSUFBRyxJQUFJLElBQUksb0JBQVksQ0FBQyxXQUFXLEVBQUM7UUFDaEMsSUFBSSxLQUFLLEdBQW9CLElBQUksZ0JBQWdCLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUMzRCxPQUFPLEtBQUssQ0FBQztLQUNoQjtTQUFNLElBQUcsSUFBSSxJQUFJLG9CQUFZLENBQUMsU0FBUyxFQUFDO1FBQ3JDLElBQUksS0FBSyxHQUF3QixJQUFJLG9CQUFvQixDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDbkUsT0FBTyxLQUFLLENBQUM7S0FDaEI7SUFDRCwwQkFBMEI7SUFDMUIsTUFBTSxJQUFJLEtBQUssQ0FBQyw2Q0FBNkMsR0FBRyxJQUFJLENBQUMsQ0FBQztBQUMxRSxDQUFDLENBQUE7QUFFRDs7R0FFRztBQUNILE1BQXNCLFNBQVM7SUF1RTdCO1FBdEVVLGFBQVEsR0FBVSxlQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRWxDLFlBQU8sR0FBaUIsRUFBRSxDQUFDLENBQUMsNEJBQTRCO1FBSWxFOzthQUVLO1FBQ0wsZUFBVSxHQUFHLEdBQWlCLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBRTlDLG9CQUFlLEdBQUcsR0FBVSxFQUFFLENBQUMsb0JBQVksQ0FBQyxhQUFhLENBQUM7UUFFMUQ7Ozs7O2FBS0s7UUFDTCxv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O0lBQ0wsVUFBVSxDQUFDLEtBQVksRUFBRSxTQUFnQixDQUFDO1FBQ3hDLE1BQU0sR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksMkJBQWlCLEVBQUUsQ0FBQztRQUN0QyxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRUQ7O1NBRUs7SUFDTCxRQUFRO1FBQ04sTUFBTSxTQUFTLEdBQVUsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzFDLE1BQU0sT0FBTyxHQUFVLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDOUMsTUFBTSxLQUFLLEdBQVUsU0FBUyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQ3ZELE1BQU0sSUFBSSxHQUFpQixDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNoRCxPQUFPLGVBQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFRDs7U0FFSztJQUNMLFFBQVE7UUFDTixPQUFPLFFBQVEsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7SUFDL0MsQ0FBQztDQWFGO0FBbERELG9EQWtEQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQHBhY2thZ2VEb2N1bWVudGF0aW9uXG4gKiBAbW9kdWxlIEFWTUFQSS1PcGVyYXRpb25zXG4gKi9cbmltcG9ydCB7IEJ1ZmZlciB9IGZyb20gJ2J1ZmZlci8nO1xuaW1wb3J0IEJpblRvb2xzIGZyb20gJy4uLy4uL3V0aWxzL2JpbnRvb2xzJztcbmltcG9ydCB7IFVUWE9JRCwgQVZNQ29uc3RhbnRzLCBTaWdJZHggfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IE5GVFRyYW5zZmVyT3V0cHV0LCBPdXRwdXRPd25lcnMgfSBmcm9tICcuL291dHB1dHMnO1xuaW1wb3J0IEJOIGZyb20gXCJibi5qc1wiO1xuXG5jb25zdCBiaW50b29scyA9IEJpblRvb2xzLmdldEluc3RhbmNlKCk7XG5cbi8qKlxuICogVGFrZXMgYSBidWZmZXIgcmVwcmVzZW50aW5nIHRoZSBvdXRwdXQgYW5kIHJldHVybnMgdGhlIHByb3BlciBbW09wZXJhdGlvbl1dIGluc3RhbmNlLlxuICpcbiAqIEBwYXJhbSBvcGlkIEEgbnVtYmVyIHJlcHJlc2VudGluZyB0aGUgb3BlcmF0aW9uIElEIHBhcnNlZCBwcmlvciB0byB0aGUgYnl0ZXMgcGFzc2VkIGluXG4gKlxuICogQHJldHVybnMgQW4gaW5zdGFuY2Ugb2YgYW4gW1tPcGVyYXRpb25dXS1leHRlbmRlZCBjbGFzcy5cbiAqL1xuZXhwb3J0IGNvbnN0IFNlbGVjdE9wZXJhdGlvbkNsYXNzID0gKG9waWQ6bnVtYmVyLCAuLi5hcmdzOkFycmF5PGFueT4pOk9wZXJhdGlvbiA9PiB7XG4gICAgaWYob3BpZCA9PSBBVk1Db25zdGFudHMuTkZUTUlOVE9QSUQpe1xuICAgICAgICBsZXQgbmZ0b3A6TkZUTWludE9wZXJhdGlvbiA9IG5ldyBORlRNaW50T3BlcmF0aW9uKC4uLmFyZ3MpO1xuICAgICAgICByZXR1cm4gbmZ0b3A7XG4gICAgfSBlbHNlIGlmKG9waWQgPT0gQVZNQ29uc3RhbnRzLk5GVFhGRVJPUCl7XG4gICAgICAgIGxldCBuZnRvcDpORlRUcmFuc2Zlck9wZXJhdGlvbiA9IG5ldyBORlRUcmFuc2Zlck9wZXJhdGlvbiguLi5hcmdzKTtcbiAgICAgICAgcmV0dXJuIG5mdG9wO1xuICAgIH1cbiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgIHRocm93IG5ldyBFcnJvcihcIkVycm9yIC0gU2VsZWN0T3BlcmF0aW9uQ2xhc3M6IHVua25vd24gb3BpZCBcIiArIG9waWQpO1xufVxuXG4vKipcbiAqIEEgY2xhc3MgcmVwcmVzZW50aW5nIGFuIG9wZXJhdGlvbi4gQWxsIG9wZXJhdGlvbiB0eXBlcyBtdXN0IGV4dGVuZCBvbiB0aGlzIGNsYXNzLlxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgT3BlcmF0aW9uIHtcbiAgcHJvdGVjdGVkIHNpZ0NvdW50OkJ1ZmZlciA9IEJ1ZmZlci5hbGxvYyg0KTtcblxuICBwcm90ZWN0ZWQgc2lnSWR4czpBcnJheTxTaWdJZHg+ID0gW107IC8vIGlkeHMgb2Ygc2lnbmVycyBmcm9tIHV0eG9cblxuICBhYnN0cmFjdCBnZXRPcGVyYXRpb25JRCgpOm51bWJlcjtcblxuICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBhcnJheSBvZiBbW1NpZ0lkeF1dIGZvciB0aGlzIFtbT3BlcmF0aW9uXV1cbiAgICAgKi9cbiAgZ2V0U2lnSWR4cyA9ICgpOkFycmF5PFNpZ0lkeD4gPT4gdGhpcy5zaWdJZHhzO1xuXG4gIGdldENyZWRlbnRpYWxJRCA9ICgpOm51bWJlciA9PiBBVk1Db25zdGFudHMuTkZUQ1JFREVOVElBTDtcblxuICAvKipcbiAgICAgKiBDcmVhdGVzIGFuZCBhZGRzIGEgW1tTaWdJZHhdXSB0byB0aGUgW1tPcGVyYXRpb25dXS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBhZGRyZXNzSWR4IFRoZSBpbmRleCBvZiB0aGUgYWRkcmVzcyB0byByZWZlcmVuY2UgaW4gdGhlIHNpZ25hdHVyZXNcbiAgICAgKiBAcGFyYW0gYWRkcmVzcyBUaGUgYWRkcmVzcyBvZiB0aGUgc291cmNlIG9mIHRoZSBzaWduYXR1cmVcbiAgICAgKi9cbiAgYWRkU2lnbmF0dXJlSWR4ID0gKGFkZHJlc3NJZHg6bnVtYmVyLCBhZGRyZXNzOkJ1ZmZlcikgPT4ge1xuICAgIGNvbnN0IHNpZ2lkeDpTaWdJZHggPSBuZXcgU2lnSWR4KCk7XG4gICAgY29uc3QgYjpCdWZmZXIgPSBCdWZmZXIuYWxsb2MoNCk7XG4gICAgYi53cml0ZVVJbnQzMkJFKGFkZHJlc3NJZHgsIDApO1xuICAgIHNpZ2lkeC5mcm9tQnVmZmVyKGIpO1xuICAgIHNpZ2lkeC5zZXRTb3VyY2UoYWRkcmVzcyk7XG4gICAgdGhpcy5zaWdJZHhzLnB1c2goc2lnaWR4KTtcbiAgICB0aGlzLnNpZ0NvdW50LndyaXRlVUludDMyQkUodGhpcy5zaWdJZHhzLmxlbmd0aCwgMCk7XG4gIH07XG5cbiAgZnJvbUJ1ZmZlcihieXRlczpCdWZmZXIsIG9mZnNldDpudW1iZXIgPSAwKTpudW1iZXIge1xuICAgIHRoaXMuc2lnQ291bnQgPSBiaW50b29scy5jb3B5RnJvbShieXRlcywgb2Zmc2V0LCBvZmZzZXQgKyA0KTtcbiAgICBvZmZzZXQgKz0gNDtcbiAgICBjb25zdCBzaWdDb3VudDpudW1iZXIgPSB0aGlzLnNpZ0NvdW50LnJlYWRVSW50MzJCRSgwKTtcbiAgICB0aGlzLnNpZ0lkeHMgPSBbXTtcbiAgICBmb3IgKGxldCBpOm51bWJlciA9IDA7IGkgPCBzaWdDb3VudDsgaSsrKSB7XG4gICAgICBjb25zdCBzaWdpZHg6U2lnSWR4ID0gbmV3IFNpZ0lkeCgpO1xuICAgICAgY29uc3Qgc2lnYnVmZjpCdWZmZXIgPSBiaW50b29scy5jb3B5RnJvbShieXRlcywgb2Zmc2V0LCBvZmZzZXQgKyA0KTtcbiAgICAgIHNpZ2lkeC5mcm9tQnVmZmVyKHNpZ2J1ZmYpO1xuICAgICAgb2Zmc2V0ICs9IDQ7XG4gICAgICB0aGlzLnNpZ0lkeHMucHVzaChzaWdpZHgpO1xuICAgIH1cbiAgICByZXR1cm4gb2Zmc2V0O1xuICB9XG5cbiAgdG9CdWZmZXIoKTpCdWZmZXIge1xuICAgIHRoaXMuc2lnQ291bnQud3JpdGVVSW50MzJCRSh0aGlzLnNpZ0lkeHMubGVuZ3RoLCAwKTtcbiAgICBsZXQgYnNpemU6bnVtYmVyID0gdGhpcy5zaWdDb3VudC5sZW5ndGg7XG4gICAgY29uc3QgYmFycjpBcnJheTxCdWZmZXI+ID0gW3RoaXMuc2lnQ291bnRdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zaWdJZHhzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBiOkJ1ZmZlciA9IHRoaXMuc2lnSWR4c1tpXS50b0J1ZmZlcigpO1xuICAgICAgYmFyci5wdXNoKGIpO1xuICAgICAgYnNpemUgKz0gYi5sZW5ndGg7XG4gICAgfVxuICAgIHJldHVybiBCdWZmZXIuY29uY2F0KGJhcnIsIGJzaXplKTtcbiAgfVxuXG4gIHN0YXRpYyBjb21wYXJhdG9yID0gKCk6KGE6T3BlcmF0aW9uLCBiOk9wZXJhdGlvbikgPT4gKDF8LTF8MCkgPT4gKGE6T3BlcmF0aW9uLCBiOk9wZXJhdGlvbik6KDF8LTF8MCkgPT4ge1xuICAgIGNvbnN0IGFvdXRpZDpCdWZmZXIgPSBCdWZmZXIuYWxsb2MoNCk7XG4gICAgYW91dGlkLndyaXRlVUludDMyQkUoYS5nZXRPcGVyYXRpb25JRCgpLCAwKTtcbiAgICBjb25zdCBhYnVmZjpCdWZmZXIgPSBhLnRvQnVmZmVyKCk7XG5cbiAgICBjb25zdCBib3V0aWQ6QnVmZmVyID0gQnVmZmVyLmFsbG9jKDQpO1xuICAgIGJvdXRpZC53cml0ZVVJbnQzMkJFKGIuZ2V0T3BlcmF0aW9uSUQoKSwgMCk7XG4gICAgY29uc3QgYmJ1ZmY6QnVmZmVyID0gYi50b0J1ZmZlcigpO1xuXG4gICAgY29uc3QgYXNvcnQ6QnVmZmVyID0gQnVmZmVyLmNvbmNhdChbYW91dGlkLCBhYnVmZl0sIGFvdXRpZC5sZW5ndGggKyBhYnVmZi5sZW5ndGgpO1xuICAgIGNvbnN0IGJzb3J0OkJ1ZmZlciA9IEJ1ZmZlci5jb25jYXQoW2JvdXRpZCwgYmJ1ZmZdLCBib3V0aWQubGVuZ3RoICsgYmJ1ZmYubGVuZ3RoKTtcbiAgICByZXR1cm4gQnVmZmVyLmNvbXBhcmUoYXNvcnQsIGJzb3J0KSBhcyAoMXwtMXwwKTtcbiAgfTtcblxuICBjb25zdHJ1Y3RvcigpIHt9XG59XG5cbi8qKlxuICogQSBjbGFzcyB3aGljaCBjb250YWlucyBhbiBbW09wZXJhdGlvbl1dIGZvciB0cmFuc2ZlcnMuXG4gKlxuICovXG5leHBvcnQgY2xhc3MgVHJhbnNmZXJhYmxlT3BlcmF0aW9uIHtcbiAgcHJvdGVjdGVkIGFzc2V0aWQ6QnVmZmVyID0gQnVmZmVyLmFsbG9jKDMyKTtcblxuICBwcm90ZWN0ZWQgdXR4b0lEczpBcnJheTxVVFhPSUQ+ID0gW107XG5cbiAgcHJvdGVjdGVkIG9wZXJhdGlvbjpPcGVyYXRpb247XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gdXNlZCB0byBzb3J0IGFuIGFycmF5IG9mIFtbVHJhbnNmZXJhYmxlT3BlcmF0aW9uXV1zXG4gICAgICovXG4gICAgc3RhdGljIGNvbXBhcmF0b3IgPSAoKTooYTpUcmFuc2ZlcmFibGVPcGVyYXRpb24sIGI6VHJhbnNmZXJhYmxlT3BlcmF0aW9uKSA9PiAoMXwtMXwwKSA9PiB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihhOlRyYW5zZmVyYWJsZU9wZXJhdGlvbiwgYjpUcmFuc2ZlcmFibGVPcGVyYXRpb24pOigxfC0xfDApIHsgXG4gICAgICAgICAgICByZXR1cm4gQnVmZmVyLmNvbXBhcmUoYS50b0J1ZmZlcigpLCBiLnRvQnVmZmVyKCkpIGFzICgxfC0xfDApO1xuICAgICAgICB9XG4gICAgfVxuXG4gIGZyb21CdWZmZXIoYnl0ZXM6QnVmZmVyLCBvZmZzZXQ6bnVtYmVyID0gMCk6bnVtYmVyIHtcbiAgICB0aGlzLmFzc2V0aWQgPSBiaW50b29scy5jb3B5RnJvbShieXRlcywgb2Zmc2V0LCBvZmZzZXQgKyAzMik7XG4gICAgb2Zmc2V0ICs9IDMyO1xuICAgIGNvbnN0IG51bXV0eG9JRHM6bnVtYmVyID0gYmludG9vbHMuY29weUZyb20oYnl0ZXMsIG9mZnNldCwgb2Zmc2V0ICsgNCkucmVhZFVJbnQzMkJFKDApO1xuICAgIG9mZnNldCArPSA0O1xuICAgIHRoaXMudXR4b0lEcyA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtdXR4b0lEczsgaSsrKSB7XG4gICAgICBjb25zdCB1dHhvaWQ6VVRYT0lEID0gbmV3IFVUWE9JRCgpO1xuICAgICAgb2Zmc2V0ID0gdXR4b2lkLmZyb21CdWZmZXIoYnl0ZXMsIG9mZnNldCk7XG4gICAgICB0aGlzLnV0eG9JRHMucHVzaCh1dHhvaWQpO1xuICAgIH1cbiAgICBjb25zdCBvcGlkOm51bWJlciA9IGJpbnRvb2xzLmNvcHlGcm9tKGJ5dGVzLCBvZmZzZXQsIG9mZnNldCArIDQpLnJlYWRVSW50MzJCRSgwKTtcbiAgICBvZmZzZXQgKz0gNDtcbiAgICB0aGlzLm9wZXJhdGlvbiA9IFNlbGVjdE9wZXJhdGlvbkNsYXNzKG9waWQpO1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbi5mcm9tQnVmZmVyKGJ5dGVzLCBvZmZzZXQpO1xuICB9XG5cbiAgdG9CdWZmZXIoKTpCdWZmZXIge1xuICAgIGNvbnN0IG51bXV0eG9JRHMgPSBCdWZmZXIuYWxsb2MoNCk7XG4gICAgbnVtdXR4b0lEcy53cml0ZVVJbnQzMkJFKHRoaXMudXR4b0lEcy5sZW5ndGgsIDApO1xuICAgIGxldCBic2l6ZTpudW1iZXIgPSB0aGlzLmFzc2V0aWQubGVuZ3RoICsgbnVtdXR4b0lEcy5sZW5ndGg7XG4gICAgY29uc3QgYmFycjpBcnJheTxCdWZmZXI+ID0gW3RoaXMuYXNzZXRpZCwgbnVtdXR4b0lEc107XG4gICAgdGhpcy51dHhvSURzID0gdGhpcy51dHhvSURzLnNvcnQoVVRYT0lELmNvbXBhcmF0b3IoKSk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnV0eG9JRHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGI6QnVmZmVyID0gdGhpcy51dHhvSURzW2ldLnRvQnVmZmVyKCk7XG4gICAgICBiYXJyLnB1c2goYik7XG4gICAgICBic2l6ZSArPSBiLmxlbmd0aDtcbiAgICB9XG4gICAgY29uc3Qgb3BpZDpCdWZmZXIgPSBCdWZmZXIuYWxsb2MoNCk7XG4gICAgb3BpZC53cml0ZVVJbnQzMkJFKHRoaXMub3BlcmF0aW9uLmdldE9wZXJhdGlvbklEKCksIDApO1xuICAgIGJhcnIucHVzaChvcGlkKTtcbiAgICBic2l6ZSArPSBvcGlkLmxlbmd0aDtcbiAgICBjb25zdCBiOkJ1ZmZlciA9IHRoaXMub3BlcmF0aW9uLnRvQnVmZmVyKCk7XG4gICAgYnNpemUgKz0gYi5sZW5ndGg7XG4gICAgYmFyci5wdXNoKGIpO1xuICAgIHJldHVybiBCdWZmZXIuY29uY2F0KGJhcnIsIGJzaXplKTtcbiAgfVxuXG4gIC8qKlxuICAgICAqIFJldHVybnMgdGhlIGFzc2V0SUQgYXMgYSB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL2Zlcm9zcy9idWZmZXJ8QnVmZmVyfS5cbiAgICAgKi9cbiAgZ2V0QXNzZXRJRCA9ICgpOkJ1ZmZlciA9PiB0aGlzLmFzc2V0aWQ7XG5cbiAgLyoqXG4gICAgICogUmV0dXJucyBhbiBhcnJheSBvZiBVVFhPSURzIGluIHRoaXMgb3BlcmF0aW9uLlxuICAgICAqL1xuICBnZXRVVFhPSURzID0gKCk6QXJyYXk8VVRYT0lEPiA9PiB0aGlzLnV0eG9JRHM7XG5cbiAgLyoqXG4gICAgICogUmV0dXJucyB0aGUgb3BlcmF0aW9uXG4gICAgICovXG4gIGdldE9wZXJhdGlvbiA9ICgpOk9wZXJhdGlvbiA9PiB0aGlzLm9wZXJhdGlvbjtcblxuICBjb25zdHJ1Y3Rvcihhc3NldGlkOkJ1ZmZlciA9IHVuZGVmaW5lZCwgdXR4b2lkczpBcnJheTxVVFhPSUR8c3RyaW5nfEJ1ZmZlcj4gPSB1bmRlZmluZWQsIG9wZXJhdGlvbjpPcGVyYXRpb24gPSB1bmRlZmluZWQpIHtcbiAgICBpZiAoXG4gICAgICB0eXBlb2YgYXNzZXRpZCAhPT0gJ3VuZGVmaW5lZCcgJiYgYXNzZXRpZC5sZW5ndGggPT09IEFWTUNvbnN0YW50cy5BU1NFVElETEVOXG4gICAgICAgICAgICAmJiBvcGVyYXRpb24gaW5zdGFuY2VvZiBPcGVyYXRpb24gJiYgdHlwZW9mIHV0eG9pZHMgIT09ICd1bmRlZmluZWQnXG4gICAgICAgICAgICAmJiBBcnJheS5pc0FycmF5KHV0eG9pZHMpXG4gICAgKSB7XG4gICAgICB0aGlzLmFzc2V0aWQgPSBhc3NldGlkO1xuICAgICAgdGhpcy5vcGVyYXRpb24gPSBvcGVyYXRpb247XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHV0eG9pZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgdXR4b2lkOlVUWE9JRCA9IG5ldyBVVFhPSUQoKTtcbiAgICAgICAgaWYgKHR5cGVvZiB1dHhvaWRzW2ldID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIHV0eG9pZC5mcm9tU3RyaW5nKHV0eG9pZHNbaV0gYXMgc3RyaW5nKTtcbiAgICAgICAgfSBlbHNlIGlmICh1dHhvaWRzW2ldIGluc3RhbmNlb2YgQnVmZmVyKSB7XG4gICAgICAgICAgdXR4b2lkLmZyb21CdWZmZXIodXR4b2lkc1tpXSBhcyBCdWZmZXIpO1xuICAgICAgICB9IGVsc2UgaWYgKHV0eG9pZHNbaV0gaW5zdGFuY2VvZiBVVFhPSUQpIHtcbiAgICAgICAgICB1dHhvaWQuZnJvbVN0cmluZyh1dHhvaWRzW2ldLnRvU3RyaW5nKCkpOyAvLyBjbG9uZVxuICAgICAgICB9XG4gICAgICAgIHRoaXMudXR4b0lEcy5wdXNoKHV0eG9pZCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogQSBbW09wZXJhdGlvbl1dIGNsYXNzIHdoaWNoIHNwZWNpZmllcyBhIE5GVCBNaW50IE9wLlxuICovXG5leHBvcnQgY2xhc3MgTkZUTWludE9wZXJhdGlvbiBleHRlbmRzIE9wZXJhdGlvbiB7XG4gICAgcHJvdGVjdGVkIGdyb3VwSUQ6QnVmZmVyID0gQnVmZmVyLmFsbG9jKDQpO1xuICAgIHByb3RlY3RlZCBwYXlsb2FkOkJ1ZmZlcjtcbiAgICBwcm90ZWN0ZWQgb3V0cHV0T3duZXJzOkFycmF5PE91dHB1dE93bmVycz4gPSBbXTtcblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgdGhlIG9wZXJhdGlvbiBJRC5cbiAgICAgKi9cbiAgICBnZXRPcGVyYXRpb25JRCgpOm51bWJlciB7XG4gICAgICAgIHJldHVybiBBVk1Db25zdGFudHMuTkZUTUlOVE9QSUQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyB0aGUgcGF5bG9hZC5cbiAgICAgKi9cbiAgICBnZXRQYXlsb2FkID0gKCk6QnVmZmVyID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGF5bG9hZDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBvdXRwdXRPd25lcnMuXG4gICAgICovXG4gICAgZ2V0T3V0cHV0T3duZXJzID0gKCk6QXJyYXk8T3V0cHV0T3duZXJzPiA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLm91dHB1dE93bmVycztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQb3B1YXRlcyB0aGUgaW5zdGFuY2UgZnJvbSBhIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vZmVyb3NzL2J1ZmZlcnxCdWZmZXJ9IHJlcHJlc2VudGluZyB0aGUgW1tORlRNaW50T3BlcmF0aW9uXV0gYW5kIHJldHVybnMgdGhlIHNpemUgb2YgdGhlIG91dHB1dC5cbiAgICAgKi9cbiAgICBmcm9tQnVmZmVyKGJ5dGVzOkJ1ZmZlciwgb2Zmc2V0Om51bWJlciA9IDApOm51bWJlciB7XG4gICAgICAgIG9mZnNldCA9IHN1cGVyLmZyb21CdWZmZXIoYnl0ZXMsIG9mZnNldCk7XG4gICAgICAgIHRoaXMuZ3JvdXBJRCA9IGJpbnRvb2xzLmNvcHlGcm9tKGJ5dGVzLCBvZmZzZXQsIG9mZnNldCArIDQpO1xuICAgICAgICBvZmZzZXQgKz0gNDtcbiAgICAgICAgbGV0IHBheWxvYWRMZW46bnVtYmVyID0gYmludG9vbHMuY29weUZyb20oYnl0ZXMsIG9mZnNldCwgb2Zmc2V0ICsgNCkucmVhZFVJbnQzMkJFKDApO1xuICAgICAgICBvZmZzZXQgKz0gNDtcbiAgICAgICAgdGhpcy5wYXlsb2FkID0gYmludG9vbHMuY29weUZyb20oYnl0ZXMsIG9mZnNldCwgb2Zmc2V0ICsgcGF5bG9hZExlbik7XG4gICAgICAgIG9mZnNldCArPSBwYXlsb2FkTGVuO1xuICAgICAgICBsZXQgbnVtb3V0cHV0czpudW1iZXIgPSBiaW50b29scy5jb3B5RnJvbShieXRlcywgb2Zmc2V0LCBvZmZzZXQgKyA0KS5yZWFkVUludDMyQkUoMCk7XG4gICAgICAgIG9mZnNldCArPSA0O1xuICAgICAgICB0aGlzLm91dHB1dE93bmVycyA9IFtdO1xuICAgICAgICBmb3IobGV0IGk6bnVtYmVyID0gMDsgaSA8IG51bW91dHB1dHM7IGkrKykge1xuICAgICAgICAgICAgbGV0IGxvY2t0aW1lOkJOID0gYmludG9vbHMuZnJvbUJ1ZmZlclRvQk4oYmludG9vbHMuY29weUZyb20oYnl0ZXMsIG9mZnNldCwgb2Zmc2V0ICsgOCkpO1xuICAgICAgICAgICAgb2Zmc2V0ICs9IDg7XG4gICAgICAgICAgICBsZXQgdGhyZXNob2xkOm51bWJlciA9IGJpbnRvb2xzLmNvcHlGcm9tKGJ5dGVzLCBvZmZzZXQsIG9mZnNldCArIDQpLnJlYWRVSW50MzJCRSgwKTtcbiAgICAgICAgICAgIG9mZnNldCArPSA0O1xuICAgICAgICAgICAgbGV0IG51bWFkZHJzOm51bWJlciA9IGJpbnRvb2xzLmNvcHlGcm9tKGJ5dGVzLCBvZmZzZXQsIG9mZnNldCArIDQpLnJlYWRVSW50MzJCRSgwKTtcbiAgICAgICAgICAgIG9mZnNldCArPSA0O1xuICAgICAgICAgICAgbGV0IGFkZHJzOkFycmF5PEJ1ZmZlcj4gPSBbXTtcbiAgICAgICAgICAgIGZvcihsZXQgajpudW1iZXIgPSAwOyBqIDwgbnVtYWRkcnM7IGorKykge1xuICAgICAgICAgICAgICAgIGxldCBhZGRyOkJ1ZmZlciA9IGJpbnRvb2xzLmNvcHlGcm9tKGJ5dGVzLCBvZmZzZXQsIG9mZnNldCArIDIwKTtcbiAgICAgICAgICAgICAgICBhZGRycy5wdXNoKGFkZHIpO1xuICAgICAgICAgICAgICAgIG9mZnNldCArPSAyMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBvdXRwdXRPd25lcjpPdXRwdXRPd25lcnMgPSBuZXcgT3V0cHV0T3duZXJzKGFkZHJzLCBsb2NrdGltZSwgdGhyZXNob2xkKTtcbiAgICAgICAgICAgIHRoaXMub3V0cHV0T3duZXJzLnB1c2gob3V0cHV0T3duZXIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvZmZzZXQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyB0aGUgYnVmZmVyIHJlcHJlc2VudGluZyB0aGUgW1tORlRNaW50T3BlcmF0aW9uXV0gaW5zdGFuY2UuXG4gICAgICovXG4gICAgdG9CdWZmZXIoKTpCdWZmZXIge1xuICAgICAgICBsZXQgc3VwZXJidWZmOkJ1ZmZlciA9IHN1cGVyLnRvQnVmZmVyKCk7XG4gICAgICAgIGxldCBwYXlsb2FkbGVuOkJ1ZmZlciA9IEJ1ZmZlci5hbGxvYyg0KTtcbiAgICAgICAgcGF5bG9hZGxlbi53cml0ZVVJbnQzMkJFKHRoaXMucGF5bG9hZC5sZW5ndGgsIDApO1xuXG4gICAgICAgIGxldCBvdXRwdXRvd25lcnNsZW46QnVmZmVyID0gQnVmZmVyLmFsbG9jKDQpO1xuICAgICAgICBvdXRwdXRvd25lcnNsZW4ud3JpdGVVSW50MzJCRSh0aGlzLm91dHB1dE93bmVycy5sZW5ndGgsIDApO1xuXG4gICAgICAgIGxldCBic2l6ZTpudW1iZXIgPSBcbiAgICAgICAgICBzdXBlcmJ1ZmYubGVuZ3RoICsgXG4gICAgICAgICAgdGhpcy5ncm91cElELmxlbmd0aCArIFxuICAgICAgICAgIHBheWxvYWRsZW4ubGVuZ3RoICsgXG4gICAgICAgICAgdGhpcy5wYXlsb2FkLmxlbmd0aCArXG4gICAgICAgICAgb3V0cHV0b3duZXJzbGVuLmxlbmd0aDsgXG5cbiAgICAgICAgbGV0IGJhcnI6QXJyYXk8QnVmZmVyPiA9IFtcbiAgICAgICAgICAgIHN1cGVyYnVmZiwgXG4gICAgICAgICAgICB0aGlzLmdyb3VwSUQsXG4gICAgICAgICAgICBwYXlsb2FkbGVuLFxuICAgICAgICAgICAgdGhpcy5wYXlsb2FkLCBcbiAgICAgICAgICAgIG91dHB1dG93bmVyc2xlblxuICAgICAgICBdO1xuXG4gICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLm91dHB1dE93bmVycy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgbGV0IGI6QnVmZmVyID0gdGhpcy5vdXRwdXRPd25lcnNbaV0udG9CdWZmZXIoKTtcbiAgICAgICAgICAgIGJhcnIucHVzaChiKTtcbiAgICAgICAgICAgIGJzaXplICs9IGIubGVuZ3RoO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIEJ1ZmZlci5jb25jYXQoYmFycixic2l6ZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyBhIGJhc2UtNTggc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgW1tORlRNaW50T3BlcmF0aW9uXV0uXG4gICAgICovXG4gICAgdG9TdHJpbmcoKTpzdHJpbmcge1xuICAgICAgICByZXR1cm4gYmludG9vbHMuYnVmZmVyVG9CNTgodGhpcy50b0J1ZmZlcigpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBbiBbW09wZXJhdGlvbl1dIGNsYXNzIHdoaWNoIGNvbnRhaW5zIGFuIE5GVCBvbiBhbiBhc3NldElELlxuICAgICAqIFxuICAgICAqIEBwYXJhbSBncm91cElEIFRoZSBncm91cCB0byB3aGljaCB0byBpc3N1ZSB0aGUgTkZUIE91dHB1dFxuICAgICAqIEBwYXJhbSBwYXlsb2FkIEEge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9mZXJvc3MvYnVmZmVyfEJ1ZmZlcn0gb2YgdGhlIE5GVCBwYXlsb2FkXG4gICAgICogQHBhcmFtIG91dHB1dE93bmVycyBBbiBhcnJheSBvZiBvdXRwdXRPd25lcnNcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihncm91cElEOm51bWJlciA9IHVuZGVmaW5lZCwgcGF5bG9hZDpCdWZmZXIgPSB1bmRlZmluZWQsIG91dHB1dE93bmVyczpBcnJheTxPdXRwdXRPd25lcnM+ID0gdW5kZWZpbmVkKXtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgaWYodHlwZW9mIGdyb3VwSUQgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBwYXlsb2FkICE9PSAndW5kZWZpbmVkJyAmJiBvdXRwdXRPd25lcnMubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLmdyb3VwSUQud3JpdGVVSW50MzJCRSgoZ3JvdXBJRCA/IGdyb3VwSUQgOiAwKSwgMCk7XG4gICAgICAgICAgICB0aGlzLnBheWxvYWQgPSBwYXlsb2FkO1xuICAgICAgICAgICAgdGhpcy5vdXRwdXRPd25lcnMgPSBvdXRwdXRPd25lcnM7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8qKlxuICogQSBbW09wZXJhdGlvbl1dIGNsYXNzIHdoaWNoIHNwZWNpZmllcyBhIE5GVCBUcmFuc2ZlciBPcC5cbiAqL1xuZXhwb3J0IGNsYXNzIE5GVFRyYW5zZmVyT3BlcmF0aW9uIGV4dGVuZHMgT3BlcmF0aW9uIHtcbiAgcHJvdGVjdGVkIG91dHB1dDpORlRUcmFuc2Zlck91dHB1dDtcblxuICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBvcGVyYXRpb24gSUQuXG4gICAgICovXG4gIGdldE9wZXJhdGlvbklEKCk6bnVtYmVyIHtcbiAgICByZXR1cm4gQVZNQ29uc3RhbnRzLk5GVFhGRVJPUDtcbiAgfVxuXG4gIGdldE91dHB1dCA9ICgpOk5GVFRyYW5zZmVyT3V0cHV0ID0+IHRoaXMub3V0cHV0O1xuXG4gIC8qKlxuICAgICAqIFBvcHVhdGVzIHRoZSBpbnN0YW5jZSBmcm9tIGEge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9mZXJvc3MvYnVmZmVyfEJ1ZmZlcn0gcmVwcmVzZW50aW5nIHRoZSBbW05GVFRyYW5zZmVyT3BlcmF0aW9uXV0gYW5kIHJldHVybnMgdGhlIHNpemUgb2YgdGhlIG91dHB1dC5cbiAgICAgKi9cbiAgZnJvbUJ1ZmZlcihieXRlczpCdWZmZXIsIG9mZnNldDpudW1iZXIgPSAwKTpudW1iZXIge1xuICAgIG9mZnNldCA9IHN1cGVyLmZyb21CdWZmZXIoYnl0ZXMsIG9mZnNldCk7XG4gICAgdGhpcy5vdXRwdXQgPSBuZXcgTkZUVHJhbnNmZXJPdXRwdXQoKTtcbiAgICByZXR1cm4gdGhpcy5vdXRwdXQuZnJvbUJ1ZmZlcihieXRlcywgb2Zmc2V0KTtcbiAgfVxuXG4gIC8qKlxuICAgICAqIFJldHVybnMgdGhlIGJ1ZmZlciByZXByZXNlbnRpbmcgdGhlIFtbTkZUVHJhbnNmZXJPcGVyYXRpb25dXSBpbnN0YW5jZS5cbiAgICAgKi9cbiAgdG9CdWZmZXIoKTpCdWZmZXIge1xuICAgIGNvbnN0IHN1cGVyYnVmZjpCdWZmZXIgPSBzdXBlci50b0J1ZmZlcigpO1xuICAgIGNvbnN0IG91dGJ1ZmY6QnVmZmVyID0gdGhpcy5vdXRwdXQudG9CdWZmZXIoKTtcbiAgICBjb25zdCBic2l6ZTpudW1iZXIgPSBzdXBlcmJ1ZmYubGVuZ3RoICsgb3V0YnVmZi5sZW5ndGg7XG4gICAgY29uc3QgYmFycjpBcnJheTxCdWZmZXI+ID0gW3N1cGVyYnVmZiwgb3V0YnVmZl07XG4gICAgcmV0dXJuIEJ1ZmZlci5jb25jYXQoYmFyciwgYnNpemUpO1xuICB9XG5cbiAgLyoqXG4gICAgICogUmV0dXJucyBhIGJhc2UtNTggc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgW1tORlRUcmFuc2Zlck9wZXJhdGlvbl1dLlxuICAgICAqL1xuICB0b1N0cmluZygpOnN0cmluZyB7XG4gICAgcmV0dXJuIGJpbnRvb2xzLmJ1ZmZlclRvQjU4KHRoaXMudG9CdWZmZXIoKSk7XG4gIH1cblxuICAvKipcbiAgICAgKiBBbiBbW09wZXJhdGlvbl1dIGNsYXNzIHdoaWNoIGNvbnRhaW5zIGFuIE5GVCBvbiBhbiBhc3NldElELlxuICAgICAqXG4gICAgICogQHBhcmFtIG91dHB1dCBBbiBbW05GVFRyYW5zZmVyT3V0cHV0XV1cbiAgICAgKi9cbiAgY29uc3RydWN0b3Iob3V0cHV0Ok5GVFRyYW5zZmVyT3V0cHV0ID0gdW5kZWZpbmVkKSB7XG4gICAgc3VwZXIoKTtcbiAgICBpZiAodHlwZW9mIG91dHB1dCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHRoaXMub3V0cHV0ID0gb3V0cHV0O1xuICAgIH1cbiAgfVxufVxuIl19